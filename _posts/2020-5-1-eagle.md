---
layout: post
title:  
date: 2020-5-1 19:10:31
category: 技术
tags: Docker Docker-registry P2P golang
excerpt: ​本文介绍了自研p2p镜像分发解决方案 - Eagle
---

## Overview

镜像p2p主要用于解决大规模容器分发场景下的拉取性能问题，目前主流的开源解决方案有[Dragonfly](https://github.com/dragonflyoss/Dragonfly)(Alibaba)以及[Kraken](https://github.com/uber/kraken)，
这两种解决方案各有优缺点，设计模式也各有不同：

* Dragonfly：采用supernode中心控制设计模式，所有的peer数据传输任务以及任务的调度都由supernode负责，整个集群将管理集中在supernode组件
* Kraken：采用随机分散设计模式，Tracker组件只负责管理所有peer的连接信息(包括各个peer拥有的数据)，而实际的数据传输流程则交由各个peer自行协商决定

[Eagle](https://github.com/duyanghao/Eagle)参考了[Dragonfly](https://github.com/dragonflyoss/Dragonfly)，[Kraken](https://github.com/uber/kraken)以及[FID](https://ieeexplore.ieee.org/stamp/stamp.jsp?arnumber=8064123)的原理和特性。
在上述项目基础上去掉了一些不必要特性，保留了最核心的组件和功能，精简而实用

## 特性支持

目前`Eagle`支持如下特性：

* Non-invasive：`Eagle`对[docker](https://github.com/moby/moby)以及[docker distribution](https://github.com/docker/distribution)代码无侵入，可以无感知对接
* High-availability：`Eagle`从客户端侧以及服务端侧实现了`Tracker`以及`Seeder`的高可用，整个架构无单点故障
* SSI(Seeder Storage Interface)：`Eagle`对`Seeder`存储实现了插件式接口，用户可以根据SSI接口实现对接第三方存储(目前默认本地文件系统)
* Host level speed limit：`Eagle`提供针对整个节点P2P下载和上传的网络限速功能
* LRUCache delete policy：`Eagle`提供LRU算法实现Proxy测和Seeder测的磁盘回收功能，并提供参数限制Cache使用大小
* Lightweight：`Eagle`由少数核心组件构成，理论上是P2P系统组件的最小集合，是轻量级解决方案

未来`Eagle`希望支持如下特性：

* Peer optimal arithmetic：`Eagle`希望实现基于网络拓扑的Peer优选算法，提高传输效率以及节省跨IDC带宽
* Push notification mechanism：实现镜像上传同步更新到`Seeder` Cache，这样可以最大限度减少`Seeder`回源操作

其中，`Peer optimal arithmetic`是目前所有开源项目都没有实现的特性(参考[#244](https://github.com/uber/kraken/issues/244)和[#1311](https://github.com/dragonflyoss/Dragonfly/issues/1311))，也是本项目的重点研究对象

## 原理

Eagle由如下组件组成：

* Proxy：部署在各个节点上，充当docker的代理，对docker拉取镜像的请求进行过滤以及将请求转发给P2P网络(EagleClient)
* EagleClient：P2P网络中的Peer端，负责执行P2P下载以及上传具体任务
* Seeder：种子服务器，负责生成镜像分层的种子文件，并充当P2P网络镜像分层数据文件的第一个上传Peer
* Tracker：保存了P2P网络拓扑中每个Peer的地址信息，同时记录了每个Peer的数据下载情况
* Origin：镜像仓库，可以是任何镜像仓库([docker distribution](https://github.com/docker/distribution), [harbor](https://github.com/goharbor/harbor.git), [quay](https://github.com/quay/quay)等)的入口地址

整个架构图如下：

![](/public/img/eagle/eagle_arch.png)

当docker执行拉取镜像操作时，其请求会被Proxy劫持。Proxy会对请求进行过滤，如果是对镜像分层的拉取请求，则会转交给EagleClient执行；否则直接代理请求

EagleClient在接受到Proxy转发过来的请求后，首先判断本地磁盘是否存在对应的文件，如果存在则直接返回；否则进入P2P下载流程

整个P2P下载流程大致如下：

EagleClient首先会从Seeder获取镜像分层的种子文件。Seeder在接受到请求后，检查本地是否存在对应文件，如果不存在，则会回源拉取，然后根据数据文件生成种子文件，返回给EagleClient；
并向Tracker宣布自己作为该镜像分层的uploader。EagleClient获取到种子文件后，会向Tracker获取P2P网络中该数据文件对应分片的Peer地址和下载信息，然后依据[BT](http://bittorrent.org/beps/bep_0003.html)协议进行P2P下载

请求流程图如下：

![](/public/img/eagle/eagle_process.svg)

## 实现

### GRPC

### SSI

### LRUCache

### Code Structure

### High Availability

## Refs

* [Eagle](https://github.com/duyanghao/Eagle)